{% extends "vendors/base.html" %}
{% load number_format %}

{% block vendor_title %}System Controls - Wahid Spare Hub{% endblock %}

{% block vendor_content %}
<div class="row">
  <div class="col-lg-4 col-sm-6 mb-4">
    <div class="card">
      <div class="card-body p-3">
        <p class="text-sm mb-1 text-capitalize font-weight-bold">Total Product Categories</p>
        <h5 id="category-total-count" class="font-weight-bolder mb-0">{{ category_total_count|number_separator }}</h5>
      </div>
    </div>
  </div>
  <div class="col-lg-4 col-sm-6 mb-4">
    <div class="card">
      <div class="card-body p-3">
        <p class="text-sm mb-1 text-capitalize font-weight-bold">Visible Categories</p>
        <h5 id="category-visible-count" class="font-weight-bolder mb-0 text-success">{{ category_visible_count|number_separator }}</h5>
      </div>
    </div>
  </div>
  <div class="col-lg-4 col-sm-6 mb-4">
    <div class="card">
      <div class="card-body p-3">
        <p class="text-sm mb-1 text-capitalize font-weight-bold">Hidden Categories</p>
        <h5 id="category-hidden-count" class="font-weight-bolder mb-0 text-warning">{{ category_hidden_count|number_separator }}</h5>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div id="category-card-list" style="display: contents;">
  {% for category in category_rows %}
  {% include "admin/partials/category_card.html" with category=category %}
  {% endfor %}
  </div>

  <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
    <div class="card h-100 border border-dashed">
      <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center text-center">
        <p class="text-xs text-secondary mb-3">Create a new product category with description.</p>
        <button type="button" class="btn btn-sm bg-gradient-primary mb-0" data-bs-toggle="modal" data-bs-target="#addProductCategoryModal">
          <i class="fa-solid fa-circle-plus me-1" aria-hidden="true"></i>Add Category
          <span class="badge bg-light text-dark ms-2">New</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addProductCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="addProductCategoryForm" method="post" action="{% url 'admin_product_category_create' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add Product Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="category-name" class="form-label">Category Name</label>
            <input
              id="category-name"
              name="name"
              type="text"
              class="form-control"
              value="{{ category_form.name.value|default:'' }}"
              maxlength="80"
              required
            >
          </div>
          <div class="mb-0">
            <label for="category-description" class="form-label">Description</label>
            <textarea
              id="category-description"
              name="description"
              rows="4"
              class="form-control"
              placeholder="Short description for this product category"
            >{{ category_form.description.value|default:'' }}</textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary mb-0" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn bg-gradient-primary mb-0">Save Category</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block vendor_extra_js %}
{% if category_form.errors %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof bootstrap === "undefined") return;
    var modalElement = document.getElementById("addProductCategoryModal");
    if (!modalElement) return;
    var modal = new bootstrap.Modal(modalElement);
    modal.show();
  });
</script>
{% endif %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        var cookies = document.cookie.split(";");
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function showToast(message, isSuccess) {
      if (typeof Toastify === "undefined") return;
      Toastify({
        text: message,
        duration: 3000,
        gravity: "bottom",
        position: "center",
        close: true,
        stopOnFocus: true,
        style: {
          background: isSuccess ? "#2dce89" : "#f5365c"
        }
      }).showToast();
    }

    function setCounts(counts) {
      if (!counts) return;
      var totalEl = document.getElementById("category-total-count");
      var visibleEl = document.getElementById("category-visible-count");
      var hiddenEl = document.getElementById("category-hidden-count");
      if (totalEl) totalEl.textContent = Number(counts.total || 0).toLocaleString();
      if (visibleEl) visibleEl.textContent = Number(counts.visible || 0).toLocaleString();
      if (hiddenEl) hiddenEl.textContent = Number(counts.hidden || 0).toLocaleString();
    }

    var addCategoryForm = document.getElementById("addProductCategoryForm");
    var addCategoryModalEl = document.getElementById("addProductCategoryModal");
    var addCategoryModal = (typeof bootstrap !== "undefined" && addCategoryModalEl)
      ? bootstrap.Modal.getOrCreateInstance(addCategoryModalEl)
      : null;
    var categoryCardList = document.getElementById("category-card-list");

    if (addCategoryForm) {
      addCategoryForm.addEventListener("submit", function (event) {
        event.preventDefault();
        var formData = new FormData(addCategoryForm);

        fetch(addCategoryForm.action, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest"
          },
          body: formData
        })
          .then(function (response) { return response.json(); })
          .then(function (data) {
            if (!data.ok) {
              showToast(data.message || "Failed to add category.", false);
              return;
            }
            if (categoryCardList && data.card_html) {
              categoryCardList.insertAdjacentHTML("afterbegin", data.card_html);
            }
            setCounts(data.counts);
            addCategoryForm.reset();
            if (addCategoryModal) addCategoryModal.hide();
            showToast(data.message || "Category added successfully.", true);
          })
          .catch(function () {
            showToast("Request failed. Please try again.", false);
          });
      });
    }

    document.addEventListener("click", function (event) {
      var targetBtn = event.target.closest(".js-category-visibility-toggle");
      if (!targetBtn) return;
      event.preventDefault();
        var url = targetBtn.getAttribute("data-url");
        var isVisible = targetBtn.getAttribute("data-is-visible") === "1";
        var makeVisible = !isVisible;
        var confirmTitle = isVisible ? "Hide category?" : "Show category?";
        var confirmText = isVisible
          ? "Do you want to make this category hidden?"
          : "Do you want to make this category visible?";
        var confirmButton = isVisible ? "Yes, hide it" : "Yes, show it";
        var confirmColor = isVisible ? "#f5365c" : "#2dce89";
        if (!url) return;

        if (typeof Swal === "undefined") return;
        Swal.fire({
          title: confirmTitle,
          text: confirmText,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: confirmButton,
          cancelButtonText: "Cancel",
          confirmButtonColor: confirmColor,
          reverseButtons: true
        }).then(function (result) {
          if (!result.isConfirmed) return;

          fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": getCookie("csrftoken"),
              "X-Requested-With": "XMLHttpRequest"
            },
            body: "is_visible=" + (makeVisible ? "1" : "0")
          })
            .then(function (response) { return response.json(); })
            .then(function (data) {
              if (!data.ok) {
                showToast("Failed to update category visibility.", false);
                return;
              }
              var nowVisible = !!data.is_visible;
              targetBtn.setAttribute("data-is-visible", nowVisible ? "1" : "0");
              targetBtn.classList.remove("bg-gradient-success", "bg-gradient-warning");
              targetBtn.classList.add(nowVisible ? "bg-gradient-success" : "bg-gradient-warning");
              targetBtn.textContent = nowVisible ? "Visible" : "Hidden";
              targetBtn.title = nowVisible ? "Make hidden" : "Make visible";
              setCounts(data.counts);
              showToast(data.message || "Category visibility updated.", true);
            })
            .catch(function () {
              showToast("Request failed. Please try again.", false);
            });
        });
    });
  });
</script>
{% endblock %}
