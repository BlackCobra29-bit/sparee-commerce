{% extends "vendors/base.html" %}
{% load number_format %}

{% block vendor_title %}Seller Management - Wahid Spare Hub{% endblock %}

{% block vendor_extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">
{% endblock %}

{% block vendor_content %}
<div class="row">
  <div class="col-12">
    <div class="card mb-4">
      <div class="card-header pb-0">
        <h6>Seller Management Page</h6>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-items-center mb-0" id="sellerManagementTable">
            <thead>
              <tr>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Seller</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Verification Status</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Performance Indicators</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Approve / Reject</th>
              </tr>
            </thead>
            <tbody>
              {% for seller in seller_rows %}
              {% include "admin/partials/seller_row.html" with seller=seller %}
              {% empty %}
              <tr>
                <td colspan="4" class="text-center text-sm text-secondary py-4">No seller records found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block vendor_extra_js %}
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof DataTable !== "undefined") {
      new DataTable("#sellerManagementTable", {
        pageLength: 10,
        order: [[0, "asc"]],
        language: {
          search: "Search sellers:"
        }
      });
    }

    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        var cookies = document.cookie.split(";");
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function showToast(message, isSuccess) {
      if (typeof Toastify === "undefined") return;
      Toastify({
        text: message,
        duration: 3000,
        gravity: "bottom",
        position: "center",
        close: true,
        stopOnFocus: true,
        style: {
          background: isSuccess ? "#2dce89" : "#f5365c"
        }
      }).showToast();
    }

    function handleSellerAction(button, action) {
      var row = button.closest("tr");
      var url = button.getAttribute("data-url");
      if (!row || !url || typeof Swal === "undefined") return;

      var titleMap = {
        approve: "Approve seller?",
        reject: "Reject seller?",
        disable: "Disable seller account?",
        enable: "Enable seller account?",
        delete: "Delete seller account permanently?"
      };
      var textMap = {
        approve: "Do you want to verify this seller account?",
        reject: "Do you want to reject this seller and disable the account?",
        disable: "Do you want to disable this verified seller account?",
        enable: "Do you want to enable this seller account?",
        delete: "This will permanently remove the seller account and delete available unsold products. Continue?"
      };
      var buttonMap = {
        approve: "Yes, approve",
        reject: "Yes, reject",
        disable: "Yes, disable",
        enable: "Yes, enable",
        delete: "Yes, delete"
      };
      var colorMap = {
        approve: "#2dce89",
        reject: "#f5365c",
        disable: "#f5365c",
        enable: "#2dce89",
        delete: "#f5365c"
      };

      Swal.fire({
        title: titleMap[action] || "Confirm action?",
        text: textMap[action] || "Proceed with this action?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: buttonMap[action] || "Yes, continue",
        cancelButtonText: "Cancel",
        confirmButtonColor: colorMap[action] || "#5e72e4",
        reverseButtons: true
      }).then(function (result) {
        if (!result.isConfirmed) return;

        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest"
          },
          body: "action=" + encodeURIComponent(action)
        })
          .then(function (response) { return response.json(); })
            .then(function (data) {
              if (!data.ok) {
                showToast(data.message || "Unable to update seller account.", false);
                return;
              }
              if (data.deleted) {
                row.remove();
                showToast(data.message || "Seller account deleted.", true);
                return;
              }
              if (data.row_html) {
                row.outerHTML = data.row_html;
              }
            showToast(data.message || "Seller verification updated.", true);
          })
          .catch(function () {
            showToast("Request failed. Please try again.", false);
          });
      });
    }

    document.addEventListener("click", function (event) {
      var actionBtn = event.target.closest(".js-seller-action");
      if (actionBtn) {
        event.preventDefault();
        handleSellerAction(actionBtn, actionBtn.getAttribute("data-action"));
      }
    });
  });
</script>
{% endblock %}
