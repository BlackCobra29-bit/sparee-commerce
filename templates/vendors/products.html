{% extends "vendors/base.html" %}
{% load static %}
{% block vendor_content %}
      <!-- Inventory Table -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header pb-0">
              <div class="row">
                <div class="col-lg-6 col-7">
                  <h6>Inventory Overview</h6>
                  <p class="text-sm mb-0">
                    <i class="fa fa-info-circle text-info" aria-hidden="true"></i>
                    <span class="font-weight-bold ms-1"><span id="productCount">{{ products|length }}</span> products</span> in inventory
                  </p>
                </div>
                <div class="col-lg-6 col-5 my-auto text-end">
                  <button class="btn btn-sm bg-gradient-primary mb-0" type="button" data-bs-toggle="modal" data-bs-target="#addProductModal">
                    <i class="fas fa-plus me-2"></i>Add Product
                  </button>
                  <span id="productsExportButtons" class="d-inline-block ms-2"></span>
                </div>
              </div>
            </div>
            <div class="card-body px-0 pb-2">
              <div class="table-responsive p-0">
                <table id="productsTable" class="table table-striped table-sm mb-0">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th class="text-center">Category</th>
                      <th class="text-center">Stock Qty</th>
                      <th class="text-center">Price</th>
                      <th class="text-center">Status</th>
                      <th class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="productsTableBody" data-rows-url="{% url 'vendor_product_rows' %}">
                    {% include "vendors/partials/product_rows.html" with products=products %}
                  </tbody>
                  </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add Product Modal -->
  <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addProductForm" method="post" action="{% url 'vendor_product_create' %}" enctype="multipart/form-data" novalidate data-parsley-validate hx-post="{% url 'vendor_product_create' %}" hx-encoding="multipart/form-data" hx-target="#productsTableBody" hx-swap="none">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label d-flex align-items-center" for="productName">
                  Product Name *
                  <span class="help-dot bg-white" data-tippy-content="Required. Enter a clear product name shown to customers, for example: Brake Pads Set." aria-label="Product name help" tabindex="0">?</span>
                </label>
                <input id="productName" name="name" type="text" class="form-control" placeholder="Enter product name" data-help="Enter at least 3 characters." required minlength="3" data-parsley-required-message="Product name is required." data-parsley-minlength="3" data-parsley-minlength-message="Product name must be at least 3 characters.">
                <div class="invalid-feedback">Please enter a valid product name.</div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label d-flex align-items-center" for="vin">
                  VIN (Vehicle Identification Number) *
                  <span class="help-dot bg-white" data-tippy-content="Required. Enter the 17-character vehicle VIN." aria-label="VIN help" tabindex="0">?</span>
                </label>
                <input id="vin" name="vin" type="text" class="form-control" placeholder="Enter 17-character VIN" maxlength="17" data-help="Required. VIN must be exactly 17 characters." required data-parsley-required-message="VIN is required." data-parsley-length="[17, 17]" data-parsley-length-message="VIN must be exactly 17 characters.">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label d-flex align-items-center" for="category">
                  Category *
                  <span class="help-dot bg-white" data-tippy-content="Required. Select the product category so buyers can filter items and you can track inventory by type." aria-label="Category help" tabindex="0">?</span>
                </label>
                <select id="category" name="category" class="form-control" data-help="Choose one category." required data-parsley-required-message="Please select a category.">
                  <option value="">Select category</option>
                  <option value="brake-parts">Brake Parts</option>
                  <option value="filters">Filters</option>
                  <option value="suspension">Suspension</option>
                  <option value="engine">Engine Parts</option>
                  <option value="electrical">Electrical</option>
                </select>
                <div class="invalid-feedback">Please select a category.</div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label d-flex align-items-center" for="price">
                  Price *
                  <span class="help-dot bg-white" data-tippy-content="Required. Enter the selling price per unit, for example: 45.00." aria-label="Price help" tabindex="0">?</span>
                </label>
                <input id="price" name="price" type="number" class="form-control" placeholder="0.00" step="0.01" min="0.01" data-help="Required. Use a positive amount, e.g. 45.00." required data-parsley-required-message="Price is required." data-parsley-min="0.01" data-parsley-min-message="Price must be greater than 0.">
                <div class="invalid-feedback">Please enter a valid price.</div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label d-flex align-items-center" for="initialStock">
                  Initial Stock Quantity *
                  <span class="help-dot bg-white" id="initialStockHelp" aria-label="Initial stock help" tabindex="0">?</span>
                </label>
                <input id="initialStock" name="initial_stock" type="number" class="form-control" placeholder="0" min="0" data-help="Required. Enter 0 or a higher whole number." required data-parsley-required-message="Initial stock is required." data-parsley-type="integer" data-parsley-min="0" data-parsley-min-message="Initial stock cannot be negative.">
                <div class="invalid-feedback">Please enter a valid stock quantity.</div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label d-flex align-items-center" for="reorderLevel">
                  Reorder Level (Optional)
                  <span class="help-dot bg-white" data-tippy-content="Optional. Set the minimum stock threshold that should trigger a restock alert." aria-label="Reorder level help" tabindex="0">?</span>
                </label>
                <input id="reorderLevel" name="reorder_level" type="number" class="form-control" placeholder="Minimum stock level" min="0" data-help="Optional. Enter 0 or a higher number." data-parsley-type="integer" data-parsley-min="0" data-parsley-min-message="Reorder level cannot be negative.">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label d-flex align-items-center" for="description">
                Description
                <span class="help-dot bg-white" data-tippy-content="Required. Add key details like fitment, material, size, or compatibility notes." aria-label="Description help" tabindex="0">?</span>
              </label>
              <textarea id="description" name="description" class="form-control" rows="3" placeholder="Product description" data-help="Describe fitment and compatibility details." required data-parsley-required-message="Description is required." maxlength="500" data-parsley-minlength="10" data-parsley-maxlength="500" data-parsley-minlength-message="Description must be at least 10 characters." data-parsley-maxlength-message="Description must be 500 characters or less."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label d-flex align-items-center" for="productImage">
                Product Image
                <span class="help-dot bg-white" data-tippy-content="Required. Upload a clear product photo (JPG or PNG, up to 5MB)." aria-label="Product image help" tabindex="0">?</span>
              </label>
              <input id="productImage" name="product_image" type="file" class="form-control" accept=".jpg,.jpeg,.png,image/jpeg,image/png" data-help="Required. Upload JPG or PNG, up to 5MB." required data-parsley-required-message="Product image is required." data-parsley-fileextension="jpg,jpeg,png" data-parsley-maxfilesize="5" data-parsley-fileextension-message="Only JPG or PNG files are allowed." data-parsley-maxfilesize-message="Image must be 5MB or smaller.">
              <small class="text-muted">Max file size: 5MB. Supported formats: JPG, PNG</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn bg-gradient-primary" form="addProductForm">Add Product</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Product Modal -->
  <div class="modal fade" id="viewProductModal" tabindex="-1" aria-labelledby="viewProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewProductModalLabel">Product Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-4">
            <div class="col-lg-5">
              <div class="card border h-100">
                <div class="card-body p-3 d-flex align-items-center justify-content-center bg-light border-radius-lg">
                  <img id="viewProductImage" src="" alt="Product image" class="img-fluid border-radius-lg" style="max-height: 360px; object-fit: cover;">
                </div>
              </div>
            </div>
            <div class="col-lg-7">
              <h4 class="mb-3" id="viewProductTitle">Product</h4>
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <div class="border rounded p-2">
                    <small class="text-muted d-block">Category</small>
                    <strong id="viewProductCategory">-</strong>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="border rounded p-2">
                    <small class="text-muted d-block">VIN</small>
                    <strong id="viewProductVin">-</strong>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="border rounded p-2">
                    <small class="text-muted d-block">Price</small>
                    <strong id="viewProductPrice">-</strong>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="border rounded p-2">
                    <small class="text-muted d-block">Stock</small>
                    <strong id="viewProductStock">-</strong>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="border rounded p-2">
                    <small class="text-muted d-block">Reorder Level</small>
                    <strong id="viewProductReorderLevel">-</strong>
                  </div>
                </div>
              </div>
              <div class="border rounded p-3">
                <small class="text-muted d-block mb-2">Description</small>
                <p class="mb-0 text-sm" id="viewProductDescription">-</p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form
            id="editProductForm"
            method="post"
            action=""
            enctype="multipart/form-data"
            novalidate
            data-parsley-validate
          >
            {% csrf_token %}
            <input type="hidden" id="editProductId" name="product_id" value="">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="editProductName">Product Name *</label>
                <input id="editProductName" name="name" type="text" class="form-control" required minlength="3">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label" for="editVin">VIN *</label>
                <input id="editVin" name="vin" type="text" class="form-control" maxlength="17" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="editCategory">Category *</label>
                <select id="editCategory" name="category" class="form-control" required>
                  <option value="">Select category</option>
                  <option value="brake-parts">Brake Parts</option>
                  <option value="filters">Filters</option>
                  <option value="suspension">Suspension</option>
                  <option value="engine">Engine Parts</option>
                  <option value="electrical">Electrical</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label" for="editPrice">Price *</label>
                <input id="editPrice" name="price" type="number" class="form-control" step="0.01" min="0.01" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="editInitialStock">Initial Stock Quantity *</label>
                <input id="editInitialStock" name="initial_stock" type="number" class="form-control" min="0" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label" for="editReorderLevel">Reorder Level (Optional)</label>
                <input id="editReorderLevel" name="reorder_level" type="number" class="form-control" min="0">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="editDescription">Description *</label>
              <textarea id="editDescription" name="description" class="form-control" rows="3" required maxlength="500"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label" for="editProductImage">Product Image (Optional)</label>
              <input id="editProductImage" name="product_image" type="file" class="form-control" accept=".jpg,.jpeg,.png,image/jpeg,image/png">
              <small class="text-muted">Leave empty to keep existing image.</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn bg-gradient-primary" form="editProductForm">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Product Modal -->
  <div class="modal fade" id="deleteProductModal" tabindex="-1" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteProductModalLabel">Delete Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">Are you sure you want to delete this product?</p>
          <p class="mb-0 text-sm text-danger">
            <strong id="deleteProductName"></strong>
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="confirmDeleteProductBtn" class="btn bg-gradient-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block vendor_extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.1.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
  .help-dot {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    user-select: none;
    margin-left: 6px;
    border: 1px solid rgba(0, 0, 0, .2);
    color: #344767;
  }

  .parsley-errors-list {
    list-style: none;
    margin: 6px 0 0;
    padding: 0;
  }

  .parsley-errors-list li {
    font-size: 12px;
    color: #b21f2d;
  }

  .form-control.parsley-error {
    border-color: rgba(220, 53, 69, 0.6);
    box-shadow: 0 0 0 0.18rem rgba(220, 53, 69, 0.12);
  }

  .form-control.parsley-success {
    border-color: rgba(8, 140, 22, 0.45);
  }

</style>
{% endblock %}

{% block vendor_extra_js %}
<script src="https://unpkg.com/htmx.org@1.9.12"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.1.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.1.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.print.min.js"></script>
<script src="{% static 'vendors/Js/index.js' %}"></script>
<script>
  (function () {
    var productsDataTable = null;
    var SELECTORS = {
      table: '#productsTable',
      tableBody: '#productsTableBody',
      productCount: '#productCount',
      addForm: '#addProductForm',
      editForm: '#editProductForm',
      viewModal: '#viewProductModal',
      viewTitle: '#viewProductTitle',
      viewImage: '#viewProductImage',
      viewCategory: '#viewProductCategory',
      viewVin: '#viewProductVin',
      viewPrice: '#viewProductPrice',
      viewStock: '#viewProductStock',
      viewReorderLevel: '#viewProductReorderLevel',
      viewDescription: '#viewProductDescription',
      addModal: '#addProductModal',
      editModal: '#editProductModal',
      deleteModal: '#deleteProductModal',
      deleteProductName: '#deleteProductName',
      confirmDeleteBtn: '#confirmDeleteProductBtn',
      exportButtons: '#productsExportButtons'
    };
    var pendingDelete = {
      url: '',
      name: ''
    };

    function initProductsDataTable() {
      var tableEl = document.querySelector(SELECTORS.table);
      if (!tableEl || typeof DataTable === 'undefined') return;

      if (productsDataTable) {
        productsDataTable.destroy();
      }

      productsDataTable = new DataTable(SELECTORS.table, {
        pageLength: 10,
        order: [],
        buttons: [
          {
            extend: 'collection',
            text: '<i class="fas fa-download me-1"></i>Export',
            className: 'btn btn-sm btn-secondary',
            autoClose: true,
            buttons: [
              { extend: 'copyHtml5', text: 'Copy' },
              { extend: 'csvHtml5', text: 'CSV' },
              { extend: 'excelHtml5', text: 'Excel' },
              { extend: 'pdfHtml5', text: 'PDF' },
              { extend: 'print', text: 'Print' }
            ]
          }
        ],
        layout: {
          topStart: 'pageLength',
          topEnd: 'search',
          bottomStart: 'info',
          bottomEnd: 'paging'
        },
        language: {
          lengthMenu: '_MENU_ entries per page',
          search: 'Search:'
        },
        columnDefs: [
          { orderable: false, targets: [5] }
        ]
      });

      var exportContainer = document.querySelector(SELECTORS.exportButtons);
      if (exportContainer && productsDataTable.buttons) {
        exportContainer.innerHTML = '';
        productsDataTable.buttons().container().appendTo(exportContainer);
      }
    }

    function showToast(type, text) {
      if (typeof Toastify === 'undefined') return;

      var bg = '#17c1e8';
      if (type === 'success') bg = '#088c16';
      if (type === 'error') bg = '#f5365c';
      if (type === 'warning') bg = '#fb6340';

      Toastify({
        text: text,
        duration: 3500,
        gravity: 'bottom',
        position: 'center',
        close: true,
        stopOnFocus: true,
        style: {
          background: bg
        }
      }).showToast();
    }

    function closeAddProductModal() {
      var modalEl = document.querySelector(SELECTORS.addModal);
      if (!modalEl || !window.bootstrap || !window.bootstrap.Modal) return;
      var modalInstance = window.bootstrap.Modal.getOrCreateInstance(modalEl);
      modalInstance.hide();
    }

    function closeEditProductModal() {
      var modalEl = document.querySelector(SELECTORS.editModal);
      if (!modalEl || !window.bootstrap || !window.bootstrap.Modal) return;
      var modalInstance = window.bootstrap.Modal.getOrCreateInstance(modalEl);
      modalInstance.hide();
    }

    function defaultProductImage() {
      return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='640' height='420' viewBox='0 0 640 420'%3E%3Crect width='640' height='420' fill='%23f3f5f7'/%3E%3Cpath d='M180 280l88-104 64 72 44-52 84 84H180z' fill='%23d2d6da'/%3E%3Ccircle cx='252' cy='142' r='30' fill='%23d2d6da'/%3E%3C/svg%3E";
    }

    function closeDeleteProductModal() {
      var modalEl = document.querySelector(SELECTORS.deleteModal);
      if (!modalEl || !window.bootstrap || !window.bootstrap.Modal) return;
      var modalInstance = window.bootstrap.Modal.getOrCreateInstance(modalEl);
      modalInstance.hide();
    }

    function resetAddProductForm() {
      var form = document.querySelector(SELECTORS.addForm);
      if (!form) return;
      form.reset();
      if (window.jQuery && window.jQuery.fn && window.jQuery.fn.parsley) {
        var parsleyInstance = window.jQuery(form).parsley();
        parsleyInstance.reset();
      }
    }

    function resetEditProductForm() {
      var form = document.querySelector(SELECTORS.editForm);
      if (!form) return;
      form.reset();
      if (window.jQuery && window.jQuery.fn && window.jQuery.fn.parsley) {
        var parsleyInstance = window.jQuery(form).parsley();
        parsleyInstance.reset();
      }
    }

    function openEditProductModalFromTrigger(triggerEl) {
      var form = document.querySelector(SELECTORS.editForm);
      if (!form || !triggerEl) return;

      var productId = triggerEl.getAttribute('data-product-id');
      var updateUrl = triggerEl.getAttribute('data-update-url');
      if (!productId || !updateUrl) return;

      form.setAttribute('action', updateUrl);
      document.getElementById('editProductId').value = productId;

      document.getElementById('editProductName').value = triggerEl.getAttribute('data-name') || '';
      document.getElementById('editVin').value = triggerEl.getAttribute('data-vin') || '';
      document.getElementById('editCategory').value = triggerEl.getAttribute('data-category') || '';
      document.getElementById('editPrice').value = triggerEl.getAttribute('data-price') || '';
      document.getElementById('editInitialStock').value = triggerEl.getAttribute('data-current-stock') || '0';
      document.getElementById('editReorderLevel').value = triggerEl.getAttribute('data-reorder-level') || '0';
      document.getElementById('editDescription').value = triggerEl.getAttribute('data-description') || '';
      document.getElementById('editProductImage').value = '';

      if (window.bootstrap && window.bootstrap.Modal) {
        var modalEl = document.querySelector(SELECTORS.editModal);
        var modalInstance = window.bootstrap.Modal.getOrCreateInstance(modalEl);
        modalInstance.show();
      }
    }

    function openViewProductModalFromTrigger(triggerEl) {
      if (!triggerEl) return;

      var titleEl = document.querySelector(SELECTORS.viewTitle);
      var imageEl = document.querySelector(SELECTORS.viewImage);
      var categoryEl = document.querySelector(SELECTORS.viewCategory);
      var vinEl = document.querySelector(SELECTORS.viewVin);
      var priceEl = document.querySelector(SELECTORS.viewPrice);
      var stockEl = document.querySelector(SELECTORS.viewStock);
      var reorderEl = document.querySelector(SELECTORS.viewReorderLevel);
      var descriptionEl = document.querySelector(SELECTORS.viewDescription);

      var name = triggerEl.getAttribute('data-name') || 'Product';
      var imageUrl = triggerEl.getAttribute('data-image-url') || '';
      var categoryLabel = triggerEl.getAttribute('data-category-label') || '-';
      var vin = triggerEl.getAttribute('data-vin') || '-';
      var price = triggerEl.getAttribute('data-price') || '-';
      var stock = triggerEl.getAttribute('data-current-stock') || '-';
      var reorderLevel = triggerEl.getAttribute('data-reorder-level') || '0';
      var description = triggerEl.getAttribute('data-description') || '-';

      if (titleEl) titleEl.textContent = name;
      if (imageEl) {
        imageEl.src = imageUrl || defaultProductImage();
        imageEl.alt = name;
      }
      if (categoryEl) categoryEl.textContent = categoryLabel;
      if (vinEl) vinEl.textContent = vin;
      if (priceEl) priceEl.textContent = '$' + price;
      if (stockEl) stockEl.textContent = stock;
      if (reorderEl) reorderEl.textContent = reorderLevel;
      if (descriptionEl) descriptionEl.textContent = description;

      if (window.bootstrap && window.bootstrap.Modal) {
        var modalEl = document.querySelector(SELECTORS.viewModal);
        var modalInstance = window.bootstrap.Modal.getOrCreateInstance(modalEl);
        modalInstance.show();
      }
    }

    function openDeleteProductModalFromTrigger(triggerEl) {
      if (!triggerEl) return;

      var deleteUrl = triggerEl.getAttribute('data-delete-url');
      var productName = triggerEl.getAttribute('data-product-name') || 'Selected product';
      if (!deleteUrl) return;

      pendingDelete.url = deleteUrl;
      pendingDelete.name = productName;

      var nameEl = document.querySelector(SELECTORS.deleteProductName);
      if (nameEl) nameEl.textContent = productName;

      if (window.bootstrap && window.bootstrap.Modal) {
        var modalEl = document.querySelector(SELECTORS.deleteModal);
        var modalInstance = window.bootstrap.Modal.getOrCreateInstance(modalEl);
        modalInstance.show();
      }
    }

    function syncProductCountFromTable() {
      var countEl = document.querySelector(SELECTORS.productCount);
      var bodyEl = document.querySelector(SELECTORS.tableBody);
      if (!countEl || !bodyEl) return;

      var rows = bodyEl.querySelectorAll('tr[id^="product-row-"]');
      countEl.textContent = String(rows.length);
    }

    function refreshProductsTableFromServer() {
      var bodyEl = document.querySelector(SELECTORS.tableBody);
      if (!bodyEl) return;

      var rowsUrl = bodyEl.getAttribute('data-rows-url');
      if (!rowsUrl || typeof htmx === 'undefined') return;

      htmx.ajax('GET', rowsUrl, {
        target: SELECTORS.tableBody,
        swap: 'innerHTML'
      });
    }

    function replaceProductsTableRows(rowsHtml) {
      var bodyEl = document.querySelector(SELECTORS.tableBody);
      if (!bodyEl) return;

      if (productsDataTable) {
        productsDataTable.destroy();
        productsDataTable = null;
      }

      bodyEl.innerHTML = rowsHtml;
      syncProductCountFromTable();
      initProductsDataTable();
    }

    function parseJsonSafely(response) {
      return response.text().then(function (text) {
        if (!text) return {};
        try {
          return JSON.parse(text);
        } catch (_error) {
          return {};
        }
      });
    }

    function getCookie(name) {
      if (!document.cookie) return '';
      var csrfCookies = document.cookie.split(';').map(function (c) { return c.trim(); });
      for (var i = 0; i < csrfCookies.length; i += 1) {
        if (csrfCookies[i].substring(0, name.length + 1) === (name + '=')) {
          return decodeURIComponent(csrfCookies[i].substring(name.length + 1));
        }
      }
      return '';
    }

    function submitEditProduct(formEl) {
      var actionUrl = formEl.getAttribute('action');
      if (!actionUrl) return Promise.resolve(false);

      var formData = new FormData(formEl);
      return fetch(actionUrl, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
      })
        .then(function (response) {
          return parseJsonSafely(response).then(function (data) {
            return { ok: response.ok, data: data };
          });
        })
        .then(function (result) {
          if (!result.ok || !result.data || !result.data.ok) {
            showToast('error', (result.data && result.data.message) || 'Unable to update product. Please try again.');
            return false;
          }

          if (typeof result.data.rows_html === 'string') {
            replaceProductsTableRows(result.data.rows_html);
          } else {
            refreshProductsTableFromServer();
          }

          closeEditProductModal();
          resetEditProductForm();
          showToast('success', result.data.message || 'Product updated successfully.');
          return true;
        })
        .catch(function () {
          showToast('error', 'Unable to update product. Please try again.');
          return false;
        });
    }

    function submitDeleteProduct(deleteUrl) {
      if (!deleteUrl) return Promise.resolve(false);

      return fetch(deleteUrl, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
      })
        .then(function (response) {
          return parseJsonSafely(response).then(function (data) {
            return { ok: response.ok, data: data };
          });
        })
        .then(function (result) {
          if (!result.ok || !result.data || !result.data.ok) {
            showToast('error', (result.data && result.data.message) || 'Unable to delete product. Please try again.');
            return false;
          }

          if (typeof result.data.rows_html === 'string') {
            replaceProductsTableRows(result.data.rows_html);
          } else {
            refreshProductsTableFromServer();
          }

          closeDeleteProductModal();
          showToast('success', result.data.message || 'Product deleted successfully.');
          pendingDelete.url = '';
          pendingDelete.name = '';
          return true;
        })
        .catch(function () {
          showToast('error', 'Unable to delete product. Please try again.');
          return false;
        });
    }

    function setupTooltips() {
      if (typeof tippy !== 'function') return;

      tippy('[data-tippy-content]', {
        animation: 'shift-away',
        delay: [150, 0],
        arrow: true,
        placement: 'top'
      });

      var helpTargets = document.querySelectorAll('#addProductForm input[data-help], #addProductForm select[data-help], #addProductForm textarea[data-help]');
      helpTargets.forEach(function (el) {
        tippy(el, {
          content: el.getAttribute('data-help'),
          trigger: 'focus',
          placement: 'right',
          interactive: true,
          theme: 'light-border',
          maxWidth: 260
        });
      });

      tippy('#initialStockHelp', {
        allowHTML: true,
        theme: 'light-border',
        placement: 'right',
        interactive: true,
        content:
          '<div style="font-size: 13px; line-height: 1.3;">' +
          '<div style="font-weight:700; margin-bottom:6px;">Stock rules</div>' +
          '<ul style="margin:0; padding-left:18px;">' +
          '<li>Use whole numbers only</li>' +
          '<li>Set to <b>0</b> if out of stock</li>' +
          '<li>Cannot be negative</li>' +
          '</ul>' +
          '</div>'
      });
    }

    function setupParsley() {
      if (!window.jQuery || !window.jQuery.fn || !window.jQuery.fn.parsley || !window.Parsley) {
        return;
      }

      if (!window.Parsley.hasValidator || !window.Parsley.hasValidator('fileextension')) {
        window.Parsley.addValidator('fileextension', {
          requirementType: 'string',
          validateString: function (_value, requirement, parsleyInstance) {
            var file = parsleyInstance.$element[0] && parsleyInstance.$element[0].files ? parsleyInstance.$element[0].files[0] : null;
            if (!file) return true;
            var allowed = requirement.split(',').map(function (x) { return x.trim().toLowerCase(); });
            var ext = file.name.split('.').pop();
            ext = ext ? ext.toLowerCase() : '';
            return allowed.indexOf(ext) !== -1;
          },
          messages: {
            en: 'Allowed file types: %s.'
          }
        });
      }

      if (!window.Parsley.hasValidator || !window.Parsley.hasValidator('maxfilesize')) {
        window.Parsley.addValidator('maxfilesize', {
          requirementType: 'integer',
          validateString: function (_value, maxSizeMb, parsleyInstance) {
            var file = parsleyInstance.$element[0] && parsleyInstance.$element[0].files ? parsleyInstance.$element[0].files[0] : null;
            if (!file) return true;
            return file.size <= maxSizeMb * 1024 * 1024;
          },
          messages: {
            en: 'File must be %sMB or smaller.'
          }
        });
      }

      window.jQuery('form[data-parsley-validate]').each(function () {
        var $form = window.jQuery(this);
        if ($form.data('Parsley')) return;

        $form.parsley({
          errorsWrapper: '<ul class="parsley-errors-list"></ul>',
          errorTemplate: '<li></li>',
          trigger: 'change input',
          validateIfEmpty: true
        });
      });
    }

    function initProductPageUi() {
      initProductsDataTable();
      setupTooltips();
      setupParsley();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initProductPageUi);
    } else {
      initProductPageUi();
    }

    document.addEventListener('shown.bs.modal', function (event) {
      if (!event.target || (event.target.id !== 'addProductModal' && event.target.id !== 'viewProductModal' && event.target.id !== 'editProductModal' && event.target.id !== 'deleteProductModal')) return;
      setupParsley();
    });

    document.addEventListener('click', function (event) {
      var viewTrigger = event.target.closest('.js-view-product');
      if (viewTrigger) {
        event.preventDefault();
        openViewProductModalFromTrigger(viewTrigger);
        return;
      }

      var editTrigger = event.target.closest('.js-edit-product');
      if (editTrigger) {
        event.preventDefault();
        openEditProductModalFromTrigger(editTrigger);
        return;
      }

      var deleteTrigger = event.target.closest('.js-delete-product');
      if (deleteTrigger) {
        event.preventDefault();
        openDeleteProductModalFromTrigger(deleteTrigger);
      }
    });

    var editProductForm = document.querySelector(SELECTORS.editForm);
    if (editProductForm) {
      editProductForm.addEventListener('submit', function (event) {
        event.preventDefault();

        if (window.jQuery && window.jQuery.fn && window.jQuery.fn.parsley) {
          var parsleyInstance = window.jQuery(editProductForm).parsley();
          if (!parsleyInstance.validate()) {
            return;
          }
        }

        submitEditProduct(editProductForm);
      });
    }

    var confirmDeleteBtn = document.querySelector(SELECTORS.confirmDeleteBtn);
    if (confirmDeleteBtn) {
      confirmDeleteBtn.addEventListener('click', function () {
        if (!pendingDelete.url) return;
        submitDeleteProduct(pendingDelete.url);
      });
    }

    document.body.addEventListener('htmx:afterSwap', function (event) {
      if (!event.target || event.target.id !== 'productsTableBody') return;
      syncProductCountFromTable();
      initProductsDataTable();
    });

    document.body.addEventListener('product:create:success', function (event) {
      var detail = event && event.detail ? event.detail : {};
      closeAddProductModal();
      resetAddProductForm();
      refreshProductsTableFromServer();
      showToast('success', detail.message || 'Product added successfully.');
    });

    document.body.addEventListener('product:create:error', function (event) {
      var detail = event && event.detail ? event.detail : {};
      showToast('error', detail.message || 'Unable to add product. Please try again.');
    });

    document.body.addEventListener('product:update:success', function (event) {
      var detail = event && event.detail ? event.detail : {};
      closeEditProductModal();
      resetEditProductForm();
      refreshProductsTableFromServer();
      showToast('success', detail.message || 'Product updated successfully.');
    });

    document.body.addEventListener('product:delete:success', function (event) {
      var detail = event && event.detail ? event.detail : {};
      closeDeleteProductModal();
      refreshProductsTableFromServer();
      showToast('success', detail.message || 'Product deleted successfully.');
    });

    document.body.addEventListener('product:delete:error', function (event) {
      var detail = event && event.detail ? event.detail : {};
      showToast('error', detail.message || 'Unable to delete product. Please try again.');
    });
  })();
</script>
{% if messages %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    {% for message in messages %}
      if (typeof Toastify !== 'undefined') {
        Toastify({
          text: '{{ message|escapejs }}',
          duration: 3500,
          gravity: 'bottom',
          position: 'center',
          close: true,
          stopOnFocus: true,
          style: {
            background: '{% if "success" in message.tags %}#2dce89{% elif "warning" in message.tags %}#fb6340{% else %}#f5365c{% endif %}'
          }
        }).showToast();
      }
    {% endfor %}
  });
</script>
{% endif %}
{% endblock %}
